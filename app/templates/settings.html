{% extends "base.html" %}

{% block title %}Settings - AlexStocks{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Profile & Settings</h1>
        <p class="text-lg text-gray-600">Manage your profile information and notification preferences</p>
    </div>

    <!-- Error Alert -->
    <div id="error-alert" class="hidden bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg mb-6">
        <div class="flex items-center">
            <i class="fas fa-exclamation-circle mr-2"></i>
            <span id="error-message"></span>
        </div>
    </div>

    <!-- Success Alert -->
    <div id="success-alert" class="hidden bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg mb-6">
        <div class="flex items-center">
            <i class="fas fa-check-circle mr-2"></i>
            <span>Profile updated successfully!</span>
        </div>
    </div>

    <!-- Profile Section -->
    <div class="bg-white rounded-lg shadow-sm border p-8 mb-6">
        <h2 class="text-2xl font-semibold text-gray-900 mb-6">Profile Information</h2>
        
        <div class="space-y-6">
            <!-- Avatar (Read-only, from Gmail) -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Avatar</label>
                <div class="flex items-center space-x-4">
                    <div id="avatar-preview" class="w-20 h-20 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden">
                        <img id="avatar-img" src="" alt="Avatar" class="w-full h-full object-cover hidden">
                        <i class="fas fa-user text-gray-400 text-3xl" id="avatar-placeholder"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm text-gray-600">Your avatar is managed by your Google account and cannot be changed here.</p>
                    </div>
                </div>
            </div>

            <!-- Nickname -->
            <div>
                <label for="nickname" class="block text-sm font-medium text-gray-700 mb-2">
                    Nickname <span class="text-red-500">*</span>
                </label>
                <input 
                    type="text" 
                    id="nickname" 
                    maxlength="100"
                    placeholder="Enter your nickname"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                >
                <p class="text-sm text-gray-500 mt-1">Your display name (must be unique)</p>
                <p id="nickname-error" class="text-sm text-red-600 mt-1 hidden"></p>
            </div>

            <!-- Email (Read-only) -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                <input 
                    type="email" 
                    id="email" 
                    readonly
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600 cursor-not-allowed"
                >
                <p class="text-sm text-gray-500 mt-1">Email cannot be changed</p>
            </div>

            <!-- Timezone -->
            <div>
                <label for="timezone" class="block text-sm font-medium text-gray-700 mb-2">Timezone</label>
                <select 
                    id="timezone" 
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                >
                    <option value="UTC">UTC</option>
                    <option value="America/New_York">Eastern Time (ET)</option>
                    <option value="America/Chicago">Central Time (CT)</option>
                    <option value="America/Denver">Mountain Time (MT)</option>
                    <option value="America/Los_Angeles">Pacific Time (PT)</option>
                    <option value="Europe/London">London (GMT)</option>
                    <option value="Europe/Paris">Paris (CET)</option>
                    <option value="Asia/Tokyo">Tokyo (JST)</option>
                    <option value="Asia/Shanghai">Shanghai (CST)</option>
                    <option value="Asia/Dubai">Dubai (GST)</option>
                    <option value="Asia/Jerusalem">Jerusalem (IST)</option>
                    <option value="Australia/Sydney">Sydney (AEDT)</option>
                </select>
                <p class="text-sm text-gray-500 mt-1">Select your timezone for date/time displays</p>
            </div>
        </div>
    </div>

    <!-- Notification Preferences Section -->
    <div class="bg-white rounded-lg shadow-sm border p-8 mb-6">
        <h2 class="text-2xl font-semibold text-gray-900 mb-6">Notification Preferences</h2>
        
        <div class="space-y-4">
            <div>
                <label class="flex items-center">
                    <input 
                        type="checkbox" 
                        id="notify-on-surges" 
                        class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                    >
                    <span class="ml-2 text-sm font-medium text-gray-700">Notify on surges of followed stocks</span>
                </label>
                <p class="text-sm text-gray-500 ml-6 mt-1">Receive alerts when tickers you follow have unusual discussion activity (surges)</p>
            </div>

            <div>
                <label class="flex items-center">
                    <input 
                        type="checkbox" 
                        id="notify-on-most-discussed" 
                        class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                    >
                    <span class="ml-2 text-sm font-medium text-gray-700">Notify about most discussed stocks</span>
                </label>
                <p class="text-sm text-gray-500 ml-6 mt-1">Get notified when new stocks become the most discussed on the platform</p>
            </div>
        </div>
    </div>

    <!-- Save Button -->
    <div class="flex justify-end space-x-4">
        <button 
            id="save-button" 
            class="px-6 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
        >
            <i class="fas fa-save mr-2"></i>Save Changes
        </button>
    </div>
</div>

<script>
let profileData = null;
let isSaving = false;

// Load profile data on page load
async function loadProfile() {
    try {
        const response = await fetch('/api/users/me', {
            credentials: 'include'
        });
        
        if (!response.ok) {
            if (response.status === 401) {
                window.location.href = '/auth/login';
                return;
            }
            throw new Error('Failed to load profile');
        }
        
        profileData = await response.json();
        populateForm(profileData);
    } catch (error) {
        showError('Failed to load profile data. Please refresh the page.');
        console.error('Error loading profile:', error);
    }
}

// Populate form with profile data
function populateForm(data) {
    document.getElementById('email').value = data.email || '';
    document.getElementById('nickname').value = data.nickname || '';
    document.getElementById('timezone').value = data.timezone || 'UTC';
    
    // Avatar (read-only, from Gmail)
    if (data.avatar_url) {
        updateAvatarPreview(data.avatar_url);
    } else {
        updateAvatarPreview(null);
    }
    
    // Notification defaults
    const defaults = data.notification_defaults || {};
    document.getElementById('notify-on-surges').checked = defaults.notify_on_surges === true;
    document.getElementById('notify-on-most-discussed').checked = defaults.notify_on_most_discussed === true;
}

// Update avatar preview
function updateAvatarPreview(url) {
    const img = document.getElementById('avatar-img');
    const placeholder = document.getElementById('avatar-placeholder');
    
    if (url) {
        img.src = url;
        img.classList.remove('hidden');
        placeholder.classList.add('hidden');
    } else {
        img.classList.add('hidden');
        placeholder.classList.remove('hidden');
    }
}

// Show error message
function showError(message) {
    const alert = document.getElementById('error-alert');
    const messageEl = document.getElementById('error-message');
    messageEl.textContent = message;
    alert.classList.remove('hidden');
    setTimeout(() => {
        alert.classList.add('hidden');
    }, 5000);
}

// Show success message
function showSuccess() {
    const alert = document.getElementById('success-alert');
    alert.classList.remove('hidden');
    setTimeout(() => {
        alert.classList.add('hidden');
    }, 3000);
}

// Save profile
async function saveProfile() {
    if (isSaving) return;
    
    const nickname = document.getElementById('nickname').value.trim();
    if (!nickname) {
        showError('Nickname is required');
        return;
    }
    
    isSaving = true;
    const saveButton = document.getElementById('save-button');
    saveButton.disabled = true;
    saveButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
    
    try {
        const updateData = {
            nickname: nickname,
            timezone: document.getElementById('timezone').value,
            notification_defaults: {
                notify_on_surges: document.getElementById('notify-on-surges').checked,
                notify_on_most_discussed: document.getElementById('notify-on-most-discussed').checked,
            }
        };
        
        const response = await fetch('/api/users/me', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify(updateData),
        });
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ detail: 'Failed to update profile' }));
            throw new Error(errorData.detail || 'Failed to update profile');
        }
        
        const updated = await response.json();
        profileData = updated;
        showSuccess();
    } catch (error) {
        showError(error.message || 'Failed to save changes. Please try again.');
        console.error('Error saving profile:', error);
    } finally {
        isSaving = false;
        saveButton.disabled = false;
        saveButton.innerHTML = '<i class="fas fa-save mr-2"></i>Save Changes';
    }
}

// Event listeners
document.addEventListener('DOMContentLoaded', () => {
    loadProfile();
    
    document.getElementById('save-button').addEventListener('click', saveProfile);
    
    // Nickname uniqueness check (debounced)
    let nicknameTimeout;
    document.getElementById('nickname').addEventListener('input', (e) => {
        clearTimeout(nicknameTimeout);
        const errorEl = document.getElementById('nickname-error');
        errorEl.classList.add('hidden');
        
        const nickname = e.target.value.trim();
        if (!nickname) return;
        
        nicknameTimeout = setTimeout(async () => {
            // Check if nickname changed from current
            if (profileData && nickname === profileData.nickname) {
                return;
            }
            
            // Basic validation
            if (nickname.length > 100) {
                errorEl.textContent = 'Nickname must be 100 characters or less';
                errorEl.classList.remove('hidden');
                return;
            }
        }, 500);
    });
    
    // Allow Enter key to save (but not in textarea fields)
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA' && e.target.tagName !== 'SELECT') {
            if (document.activeElement === e.target && e.target.type !== 'checkbox') {
                e.preventDefault();
                saveProfile();
            }
        }
    });
});
</script>
{% endblock %}

