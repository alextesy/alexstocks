{% extends "base.html" %}

{% block title %}{{ ticker }} - AlexStocks{% endblock %}

{% block content %}
<div class="mb-8">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">{{ ticker }}</h1>
            {% if ticker_obj %}
            <p class="text-gray-600">{{ ticker_obj.name }} - Recent news and sentiment analysis</p>
            {% else %}
            <p class="text-gray-600">Recent news and sentiment analysis</p>
            {% endif %}
            <div class="mt-2 flex items-center space-x-4 text-sm text-gray-500">
                <span class="flex items-center">
                    <i class="fas fa-newspaper mr-1"></i>
                    {{ total_article_count }} total articles
                </span>
                {% if pagination.total_pages > 1 %}
                <span class="flex items-center">
                    <i class="fas fa-list mr-1"></i>
                    Page {{ pagination.page }} of {{ pagination.total_pages }}
                </span>
                {% endif %}
            </div>
        </div>
        <a href="/" class="text-blue-600 hover:text-blue-800">
            ← Back to all tickers
        </a>
    </div>
</div>

<!-- Sentiment Analysis for this Ticker -->
{% if sentiment_histogram and sentiment_histogram["total"] > 0 %}
<div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
    <h2 class="text-lg font-semibold text-gray-900 mb-4">
        <i class="fas fa-chart-bar text-blue-600 mr-2"></i>
        {{ ticker }} Sentiment Analysis
    </h2>
    <div class="grid grid-cols-3 gap-4 mb-4">
        {% for item in sentiment_histogram.display_data %}
        <div class="text-center">
            <div class="text-2xl mb-1">{{ item.icon }}</div>
            <div class="text-lg font-bold text-gray-900">{{ item.count }}</div>
            <div class="text-sm text-gray-600">{{ item.label }}</div>
            <div class="text-xs text-gray-500">{{ item.percentage }}%</div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Visual Bar Chart -->
    <div class="flex h-4 bg-gray-200 rounded-full overflow-hidden">
        {% for item in sentiment_histogram.display_data %}
        {% if item.percentage > 0 %}
        <div 
            class="h-full" 
            style="background-color: {{ item.color }}; width: {{ item.percentage }}%"
            title="{{ item.label }}: {{ item.count }} articles ({{ item.percentage }}%)"
        ></div>
        {% endif %}
        {% endfor %}
    </div>
    
    <div class="text-xs text-gray-500 mt-2 text-center">
        Total articles analyzed: {{ sentiment_histogram["total"] }}
    </div>
</div>

<!-- Sentiment Over Time Chart -->
{% if sentiment_over_time and sentiment_over_time.data|length > 0 %}
<div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
    <h2 class="text-lg font-semibold text-gray-900 mb-4">
        <i class="fas fa-chart-bar text-blue-600 mr-2"></i>
        {{ ticker }} Daily Sentiment (Last {{ sentiment_over_time.period_days }} Days)
    </h2>
    <div class="h-64">
        <canvas id="sentimentTimeChart"></canvas>
    </div>
    <div class="text-xs text-gray-500 mt-2 text-center">
        Green bars = Positive articles, Red bars = Negative articles ({{ sentiment_over_time.total_points }} days)
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const sentimentTimeData = {{ sentiment_over_time.data | tojson }};
    
    if (sentimentTimeData && sentimentTimeData.length > 0) {
        const ctx = document.getElementById('sentimentTimeChart').getContext('2d');
        
        const chartData = {
            labels: sentimentTimeData.map(d => {
                // Format date to show only month/day for better readability
                const date = new Date(d.date);
                return `${date.getMonth() + 1}/${date.getDate()}`;
            }),
            datasets: [{
                label: 'Positive Articles',
                data: sentimentTimeData.map(d => d.positive),
                backgroundColor: '#10b981', // green-500
                borderColor: '#059669', // green-600
                borderWidth: 1
            }, {
                label: 'Negative Articles',
                data: sentimentTimeData.map(d => -d.negative), // Negative values to show below zero
                backgroundColor: '#ef4444', // red-500
                borderColor: '#dc2626', // red-600
                borderWidth: 1
            }]
        };
        
        const config = {
            type: 'bar',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        },
                        ticks: {
                            callback: function(value) {
                                return Math.abs(value); // Show absolute values
                            }
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const dataPoint = sentimentTimeData[context.dataIndex];
                                if (context.datasetIndex === 0) {
                                    return `Positive: ${context.parsed.y} articles`;
                                } else {
                                    return `Negative: ${Math.abs(context.parsed.y)} articles`;
                                }
                            }
                        }
                    }
                }
            }
        };
        
        new Chart(ctx, config);
    }
});
</script>
{% endif %}
{% elif sentiment_histogram and sentiment_histogram["total"] == 0 %}
<div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
    <h2 class="text-lg font-semibold text-gray-900 mb-4">
        <i class="fas fa-chart-bar text-blue-600 mr-2"></i>
        {{ ticker }} Sentiment Analysis
    </h2>
    <div class="text-center py-8 text-gray-500">
        <i class="fas fa-inbox text-4xl mb-4"></i>
        <p class="text-lg">No sentiment data available</p>
        <p class="text-sm">Articles for {{ ticker }} haven't been analyzed yet</p>
    </div>
</div>
{% endif %}

<!-- Filters -->
<div class="bg-white rounded-lg shadow-sm border p-4 mb-6">
    <div class="flex flex-col sm:flex-row gap-4">
        <div class="flex-1">
            <label class="block text-sm font-medium text-gray-700 mb-1">Sort By</label>
            <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" id="sort-filter">
                <option value="date-desc" {% if sort_by == "date-desc" %}selected{% endif %}>Date (Newest First)</option>
                <option value="date-asc" {% if sort_by == "date-asc" %}selected{% endif %}>Date (Oldest First)</option>
                <option value="sentiment-desc" {% if sort_by == "sentiment-desc" %}selected{% endif %}>Sentiment (High to Low)</option>
                <option value="sentiment-asc" {% if sort_by == "sentiment-asc" %}selected{% endif %}>Sentiment (Low to High)</option>
                <option value="engagement-desc" {% if sort_by == "engagement-desc" %}selected{% endif %}>Engagement (High to Low)</option>
            </select>
        </div>
        <div class="flex-1">
            <label class="block text-sm font-medium text-gray-700 mb-1">Time Range</label>
            <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" id="time-filter">
                <option value="">All time</option>
                <option value="24h">Last 24 hours</option>
                <option value="3d">Last 3 days</option>
                <option value="1w">Last week</option>
                <option value="1m">Last month</option>
            </select>
        </div>
        <div class="flex-1">
            <label class="block text-sm font-medium text-gray-700 mb-1">Language</label>
            <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" id="language-filter">
                <option value="">All languages</option>
                <option value="en">English</option>
                <option value="es">Spanish</option>
                <option value="fr">French</option>
            </select>
        </div>
        <div class="flex-1">
            <label class="block text-sm font-medium text-gray-700 mb-1">Sentiment</label>
            <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" id="article-sentiment-filter">
                <option value="">All sentiment</option>
                <option value="positive">Positive</option>
                <option value="neutral">Neutral</option>
                <option value="negative">Negative</option>
            </select>
        </div>
    </div>
</div>

<!-- Articles List -->
<div class="space-y-4" id="articles-list">
    {% for article in articles %}
    <div class="bg-white rounded-lg shadow-sm border p-4 md:p-6 article-card" 
         data-published="{{ article.published_at.isoformat() }}"
         data-language="{{ article.lang or 'unknown' }}"
         data-sentiment="{{ get_sentiment_display_data(article.sentiment).label.lower() }}"
         data-sentiment-value="{{ article.sentiment or 0.0 }}"
         data-engagement="{{ article.upvotes or 0 }}"
         data-source="{{ article.source }}">
        <!-- Title -->
        <div class="mb-3">
            <h3 class="text-base md:text-lg font-semibold text-gray-900 line-clamp-2 md:line-clamp-none mb-2">
                <a href="{{ article.url }}" target="_blank" class="hover:text-blue-600">
                    {% set title_text = article.title %}
                    {% for term in article.matched_terms %}
                        {% if term in title_text %}
                            {% set highlighted_term = '<mark class="bg-yellow-200 px-1 rounded">' + term + '</mark>' %}
                            {% set title_text = title_text.replace(term, highlighted_term) %}
                        {% else %}
                            {% set title_upper = title_text.upper() %}
                            {% set term_upper = term.upper() %}
                            {% if term_upper in title_upper %}
                                {% set highlighted_term = '<mark class="bg-yellow-200 px-1 rounded">' + term_upper + '</mark>' %}
                                {% set title_text = title_text.replace(term_upper, highlighted_term) %}
                            {% else %}
                                {% set title_lower = title_text.lower() %}
                                {% set term_lower = term.lower() %}
                                {% if term_lower in title_lower %}
                                    {% set highlighted_term = '<mark class="bg-yellow-200 px-1 rounded">' + term_lower + '</mark>' %}
                                    {% set title_text = title_text.replace(term_lower, highlighted_term) %}
                                {% endif %}
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                    {{ title_text|safe }}
                    <i class="fas fa-external-link-alt text-xs text-gray-400 ml-1"></i>
                </a>
            </h3>
            <!-- Date and Source first -->
            <div class="flex flex-wrap items-center gap-2 text-xs md:text-sm text-gray-500 mb-2">
                {% if article.published_at %}
                <span class="article-time whitespace-nowrap" data-published="{{ article.published_at.isoformat() }}"></span>
                {% else %}
                <span class="whitespace-nowrap">Unknown date</span>
                {% endif %}
                <span class="text-gray-300">•</span>
                <span class="px-2 py-1 bg-gray-100 rounded text-xs text-gray-600">{{ article.source }}</span>
            </div>
            <!-- Other metadata -->
            <div class="flex flex-wrap items-center gap-2">
                {% set sentiment_data = get_sentiment_display_data(article.sentiment) %}
                <div class="flex items-center space-x-1">
                    <span class="text-sm">{{ sentiment_data.icon }}</span>
                    <span class="px-2 py-1 text-xs font-medium rounded-full {{ sentiment_data.bg_color }} {{ sentiment_data.text_color }}" data-sentiment="{{ sentiment_data.label.lower() }}">
                        {{ sentiment_data.label }}
                    </span>
                    <span class="text-xs text-gray-500">({{ "%.2f"|format(article.sentiment) }})</span>
                </div>
                <span class="flex items-center text-gray-600 whitespace-nowrap text-xs md:text-sm">
                    <i class="fas fa-arrow-up mr-1"></i>
                    <span class="font-medium">{{ article.upvotes or 0 }}</span>
                </span>
                {% if article.lang %}
                <span class="px-2 py-1 bg-gray-100 rounded text-xs">{{ article.lang.upper() }}</span>
                {% endif %}
                {% if article.author %}
                <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs truncate max-w-[150px]">{{ article.author }}</span>
                {% endif %}
                {% if article.subreddit %}
                <span class="px-2 py-1 bg-orange-100 text-orange-800 rounded text-xs">{{ article.subreddit }}</span>
                {% endif %}
            </div>
        </div>
        
        {% if article.full_text and article.source == 'reddit_comment' %}
        <div class="mt-3 p-3 bg-gray-50 rounded-md">
            <p class="text-sm text-gray-700">
                {% set text = article.full_text %}
                {% for term in article.matched_terms %}
                    {% set found = false %}
                    {% if term in text %}
                        {% set highlighted_term = '<mark class="bg-yellow-200 px-1 rounded">' + term + '</mark>' %}
                        {% set text = text.replace(term, highlighted_term) %}
                        {% set found = true %}
                    {% endif %}
                    {% if not found %}
                        {% set text_upper = text.upper() %}
                        {% set term_upper = term.upper() %}
                        {% if term_upper in text_upper %}
                            {% set pos = text_upper.find(term_upper) %}
                            {% set before = text[:pos] %}
                            {% set after = text[pos + term_upper|length:] %}
                            {% set actual_term = text[pos:pos + term_upper|length] %}
                            {% set highlighted_term = '<mark class="bg-yellow-200 px-1 rounded">' + actual_term + '</mark>' %}
                            {% set text = before + highlighted_term + after %}
                            {% set found = true %}
                        {% endif %}
                    {% endif %}
                    {% if not found %}
                        {% set text_lower = text.lower() %}
                        {% set term_lower = term.lower() %}
                        {% if term_lower in text_lower %}
                            {% set pos = text_lower.find(term_lower) %}
                            {% set before = text[:pos] %}
                            {% set after = text[pos + term_lower|length:] %}
                            {% set actual_term = text[pos:pos + term_lower|length] %}
                            {% set highlighted_term = '<mark class="bg-yellow-200 px-1 rounded">' + actual_term + '</mark>' %}
                            {% set text = before + highlighted_term + after %}
                        {% endif %}
                    {% endif %}
                {% endfor %}
                {{ text|safe }}
            </p>
        </div>
        {% endif %}
    </div>
    {% else %}
    <div class="text-center py-12">
        <div class="text-gray-500">
            <i class="fas fa-newspaper text-4xl mb-4"></i>
            <p class="text-lg">No articles found for {{ ticker }}</p>
            <p class="text-sm">Try adjusting your filters or check back later</p>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Pagination -->
{% if pagination.total_pages > 1 %}
<div class="mt-8 flex justify-center">
    <nav class="flex items-center space-x-2">
        {% if pagination.has_prev %}
        <a href="/t/{{ ticker }}?page={{ pagination.page - 1 }}&sort_by={{ sort_by }}" 
           class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
            Previous
        </a>
        {% else %}
        <span class="px-3 py-2 text-sm font-medium text-gray-400 bg-gray-100 border border-gray-200 rounded-md cursor-not-allowed">
            Previous
        </span>
        {% endif %}
        
        <!-- Page numbers -->
        {% set start_page = [1, pagination.page - 2]|max %}
        {% set end_page = [pagination.total_pages, pagination.page + 2]|min %}
        
        {% if start_page > 1 %}
        <a href="/t/{{ ticker }}?page=1&sort_by={{ sort_by }}" 
           class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">1</a>
        {% if start_page > 2 %}
        <span class="px-2 text-sm text-gray-500">...</span>
        {% endif %}
        {% endif %}
        
        {% for page_num in range(start_page, end_page + 1) %}
        {% if page_num == pagination.page %}
        <span class="px-3 py-2 text-sm font-medium text-white bg-blue-600 border border-blue-600 rounded-md">
            {{ page_num }}
        </span>
        {% else %}
        <a href="/t/{{ ticker }}?page={{ page_num }}&sort_by={{ sort_by }}" 
           class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
            {{ page_num }}
        </a>
        {% endif %}
        {% endfor %}
        
        {% if end_page < pagination.total_pages %}
        {% if end_page < pagination.total_pages - 1 %}
        <span class="px-2 text-sm text-gray-500">...</span>
        {% endif %}
        <a href="/t/{{ ticker }}?page={{ pagination.total_pages }}&sort_by={{ sort_by }}" 
           class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
            {{ pagination.total_pages }}
        </a>
        {% endif %}
        
        {% if pagination.has_next %}
        <a href="/t/{{ ticker }}?page={{ pagination.page + 1 }}&sort_by={{ sort_by }}" 
           class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
            Next
        </a>
        {% else %}
        <span class="px-3 py-2 text-sm font-medium text-gray-400 bg-gray-100 border border-gray-200 rounded-md cursor-not-allowed">
            Next
        </span>
        {% endif %}
    </nav>
</div>

<div class="mt-4 text-center text-sm text-gray-500">
    Showing {{ ((pagination.page - 1) * 50) + 1 }} to {{ [pagination.page * 50, pagination.total_articles]|min }} of {{ pagination.total_articles }} articles
</div>
{% endif %}

<script>
// Sorting functionality - redirect with sort_by parameter
const sortFilter = document.getElementById('sort-filter');

if (sortFilter) {
    sortFilter.addEventListener('change', function() {
        const sortValue = this.value;
        const currentUrl = new URL(window.location.href);
        
        // Update or add sort_by parameter
        currentUrl.searchParams.set('sort_by', sortValue);
        
        // Reset to page 1 when changing sort
        currentUrl.searchParams.set('page', '1');
        
        // Redirect to new URL
        window.location.href = currentUrl.toString();
    });
}
</script>
{% endblock %}
