{% extends "base.html" %}

{% block title %}{{ ticker }} - AlexStocks{% endblock %}

{% block content %}
<div class="mb-8">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">{{ ticker }}</h1>
            {% if ticker_obj %}
            <p class="text-gray-600">{{ ticker_obj.name }} - Recent news and sentiment analysis</p>
            {% else %}
            <p class="text-gray-600">Recent news and sentiment analysis</p>
            {% endif %}
            <div class="mt-2 flex items-center space-x-4 text-sm text-gray-500">
                {% if pagination.total_pages > 1 %}
                <span class="flex items-center">
                    <i class="fas fa-list mr-1"></i>
                    Page {{ pagination.page }} of {{ pagination.total_pages }}
                </span>
                {% endif %}
            </div>
        </div>
        <a href="/" class="text-blue-600 hover:text-blue-800">
            ← Back to all tickers
        </a>
    </div>
</div>

<!-- Stock Price & Metrics Display -->
<div class="bg-white rounded-lg shadow-sm border p-4 md:p-6 mb-6">
    <div class="grid grid-cols-4 gap-2 md:gap-6">
        <!-- Stock Price -->
        {% if stock_data %}
        <div class="text-center">
            <h3 class="text-xs md:text-sm font-medium text-gray-500 mb-1">Current Price</h3>
            <div class="text-lg md:text-2xl font-bold text-gray-900">
                ${{ "%.2f"|format(stock_data.price) }}
            </div>
            <div class="flex flex-col md:flex-row items-center justify-center space-y-0 md:space-y-0 md:space-x-2 mt-1">
                {% set change_color = "text-green-600" if stock_data.change >= 0 else "text-red-600" %}
                <span class="text-xs md:text-sm {{ change_color }} font-medium">
                    {{ "+" if stock_data.change >= 0 else "" }}${{ "%.2f"|format(stock_data.change) }}
                </span>
                <span class="text-xs md:text-sm {{ change_color }}">
                    ({{ "+" if stock_data.change >= 0 else "" }}{{ "%.1f"|format(stock_data.change_percent) }}%)
                </span>
            </div>
            <div class="text-xs text-gray-500 mt-1">
                {{ stock_data.exchange }} • {{ stock_data.currency }}
            </div>
        </div>
        {% endif %}
        
        <!-- Today's Articles -->
        <div class="text-center">
            <h3 class="text-xs md:text-sm font-medium text-gray-500 mb-1">Today</h3>
            <div class="text-lg md:text-2xl font-bold text-gray-900">{{ today_article_count }}</div>
            <div class="flex flex-col md:flex-row items-center justify-center space-y-0 md:space-y-0 md:space-x-2 mt-1">
                {% set change_color = "text-green-600" if article_change >= 0 else "text-red-600" %}
                <span class="text-xs md:text-sm {{ change_color }} font-medium">
                    {{ "+" if article_change >= 0 else "" }}{{ article_change }}
                </span>
                <span class="text-xs md:text-sm {{ change_color }}">
                    ({{ "+" if article_change >= 0 else "" }}{{ "%.1f"|format(article_change_percent) }}%)
                </span>
            </div>
            <div class="text-xs text-gray-500 mt-1">vs yesterday</div>
        </div>
        
        <!-- Users Talking Today -->
        <div class="text-center">
            <h3 class="text-xs md:text-sm font-medium text-gray-500 mb-1">Users</h3>
            <div class="text-lg md:text-2xl font-bold text-gray-900">{{ unique_users_today }}</div>
            <div class="flex flex-col md:flex-row items-center justify-center space-y-0 md:space-y-0 md:space-x-2 mt-1">
                {% set change_color = "text-green-600" if users_change >= 0 else "text-red-600" %}
                <span class="text-xs md:text-sm {{ change_color }} font-medium">
                    {{ "+" if users_change >= 0 else "" }}{{ users_change }}
                </span>
                <span class="text-xs md:text-sm {{ change_color }}">
                    ({{ "+" if users_change >= 0 else "" }}{{ "%.1f"|format(users_change_percent) }}%)
                </span>
            </div>
            <div class="text-xs text-gray-500 mt-1">vs yesterday</div>
        </div>
        
        <!-- Total Articles -->
        <div class="text-center">
            <h3 class="text-xs md:text-sm font-medium text-gray-500 mb-1">Total</h3>
            <div class="text-lg md:text-2xl font-bold text-gray-900">{{ total_article_count }}</div>
            <div class="text-xs text-gray-500 mt-1">Since Oct 2025</div>
        </div>
    </div>
</div>

<!-- Sentiment Timeline Chart -->
<div class="bg-white rounded-lg shadow-sm border p-4 md:p-6 mb-6">
    <div class="mb-4">
        <h2 class="text-lg font-semibold text-gray-900 mb-3">
            <i class="fas fa-chart-area text-blue-600 mr-2"></i>
            {{ ticker }} Sentiment Over Time
        </h2>
        <div class="flex flex-col sm:flex-row sm:items-center gap-3">
            <div class="flex items-center space-x-2">
                <label for="metric-selector" class="text-sm font-medium text-gray-700 whitespace-nowrap">Metric:</label>
                <select id="metric-selector" class="flex-1 sm:flex-none px-3 py-1.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 text-sm">
                    <option value="comments" selected>By Comments</option>
                    <option value="users">By Unique Users</option>
                </select>
            </div>
            <div class="flex items-center space-x-2">
                <label for="period-selector" class="text-sm font-medium text-gray-700 whitespace-nowrap">Period:</label>
                <select id="period-selector" class="flex-1 sm:flex-none px-3 py-1.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 text-sm">
                    <option value="day" selected>Last 24 Hours</option>
                    <option value="week">Last 7 Days</option>
                    <option value="month">Last 30 Days</option>
                </select>
            </div>
        </div>
    </div>
    
    <div class="h-64 mb-4">
        <canvas id="sentimentAreaChart"></canvas>
    </div>
    
    <div class="flex items-center justify-center space-x-4 text-xs text-gray-600">
        <div class="flex items-center space-x-1">
            <div class="w-3 h-3 rounded-full bg-blue-400"></div>
            <span id="legend-total">Total Comments</span>
        </div>
        <div class="flex items-center space-x-1">
            <div class="w-3 h-3 rounded-full bg-green-500"></div>
            <span>Positive</span>
        </div>
        <div class="flex items-center space-x-1">
            <div class="w-3 h-3 rounded-full bg-red-500"></div>
            <span>Negative</span>
        </div>
    </div>
</div>


<!-- Filters -->
<div class="bg-white rounded-lg shadow-sm border p-4 mb-6">
    <div class="flex flex-col sm:flex-row gap-4">
        <div class="flex-1">
            <label class="block text-sm font-medium text-gray-700 mb-1">Sort By</label>
            <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" id="sort-filter">
                <option value="date-desc" {% if sort_by == "date-desc" %}selected{% endif %}>Date (Newest First)</option>
                <option value="date-asc" {% if sort_by == "date-asc" %}selected{% endif %}>Date (Oldest First)</option>
                <option value="sentiment-desc" {% if sort_by == "sentiment-desc" %}selected{% endif %}>Sentiment (High to Low)</option>
                <option value="sentiment-asc" {% if sort_by == "sentiment-asc" %}selected{% endif %}>Sentiment (Low to High)</option>
                <option value="engagement-desc" {% if sort_by == "engagement-desc" %}selected{% endif %}>Engagement (High to Low)</option>
            </select>
        </div>
        <div class="flex-1">
            <label class="block text-sm font-medium text-gray-700 mb-1">Time Range</label>
            <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" id="time-filter">
                <option value="">All time</option>
                <option value="24h">Last 24 hours</option>
                <option value="3d">Last 3 days</option>
                <option value="1w">Last week</option>
                <option value="1m">Last month</option>
            </select>
        </div>
        <div class="flex-1">
            <label class="block text-sm font-medium text-gray-700 mb-1">Language</label>
            <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" id="language-filter">
                <option value="">All languages</option>
                <option value="en">English</option>
                <option value="es">Spanish</option>
                <option value="fr">French</option>
            </select>
        </div>
        <div class="flex-1">
            <label class="block text-sm font-medium text-gray-700 mb-1">Sentiment</label>
            <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" id="article-sentiment-filter">
                <option value="">All sentiment</option>
                <option value="positive">Positive</option>
                <option value="neutral">Neutral</option>
                <option value="negative">Negative</option>
            </select>
        </div>
    </div>
</div>

<!-- Articles List -->
<div class="space-y-4" id="articles-list">
    {% for article in articles %}
    <div class="bg-white rounded-lg shadow-sm border p-4 md:p-6 article-card" 
         data-published="{{ article.published_at.isoformat() }}"
         data-language="{{ article.lang or 'unknown' }}"
         data-sentiment="{{ get_sentiment_display_data(article.sentiment).label.lower() }}"
         data-sentiment-value="{{ article.sentiment or 0.0 }}"
         data-engagement="{{ article.upvotes or 0 }}"
         data-source="{{ article.source }}">
        <!-- Title -->
        <div class="mb-3">
            <h3 class="text-base md:text-lg font-semibold text-gray-900 line-clamp-2 md:line-clamp-none mb-2">
                <a href="{{ article.url }}" target="_blank" class="hover:text-blue-600">
                    {% set title_text = article.title %}
                    {% for term in article.matched_terms %}
                        {% if term in title_text %}
                            {% set highlighted_term = '<mark class="bg-yellow-200 px-1 rounded">' + term + '</mark>' %}
                            {% set title_text = title_text.replace(term, highlighted_term) %}
                        {% else %}
                            {% set title_upper = title_text.upper() %}
                            {% set term_upper = term.upper() %}
                            {% if term_upper in title_upper %}
                                {% set highlighted_term = '<mark class="bg-yellow-200 px-1 rounded">' + term_upper + '</mark>' %}
                                {% set title_text = title_text.replace(term_upper, highlighted_term) %}
                            {% else %}
                                {% set title_lower = title_text.lower() %}
                                {% set term_lower = term.lower() %}
                                {% if term_lower in title_lower %}
                                    {% set highlighted_term = '<mark class="bg-yellow-200 px-1 rounded">' + term_lower + '</mark>' %}
                                    {% set title_text = title_text.replace(term_lower, highlighted_term) %}
                                {% endif %}
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                    {{ title_text|safe }}
                    <i class="fas fa-external-link-alt text-xs text-gray-400 ml-1"></i>
                </a>
            </h3>
            <!-- Date and Source first -->
            <div class="flex flex-wrap items-center gap-2 text-xs md:text-sm text-gray-500 mb-2">
                {% if article.published_at %}
                <span class="article-time whitespace-nowrap" data-published="{{ article.published_at.isoformat() }}"></span>
                {% else %}
                <span class="whitespace-nowrap">Unknown date</span>
                {% endif %}
                <span class="text-gray-300">•</span>
                <span class="px-2 py-1 bg-gray-100 rounded text-xs text-gray-600">{{ article.source }}</span>
            </div>
            <!-- Other metadata -->
            <div class="flex flex-wrap items-center gap-2">
                {% set sentiment_data = get_sentiment_display_data(article.sentiment) %}
                <div class="flex items-center space-x-1">
                    <span class="text-sm">{{ sentiment_data.icon }}</span>
                    <span class="px-2 py-1 text-xs font-medium rounded-full {{ sentiment_data.bg_color }} {{ sentiment_data.text_color }}" data-sentiment="{{ sentiment_data.label.lower() }}">
                        {{ sentiment_data.label }}
                    </span>
                    <span class="text-xs text-gray-500">({{ "%.2f"|format(article.sentiment) }})</span>
                </div>
                <span class="flex items-center text-gray-600 whitespace-nowrap text-xs md:text-sm">
                    <i class="fas fa-arrow-up mr-1"></i>
                    <span class="font-medium">{{ article.upvotes or 0 }}</span>
                </span>
                {% if article.lang %}
                <span class="px-2 py-1 bg-gray-100 rounded text-xs">{{ article.lang.upper() }}</span>
                {% endif %}
                {% if article.author %}
                <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs truncate max-w-[150px]">{{ article.author }}</span>
                {% endif %}
                {% if article.subreddit %}
                <span class="px-2 py-1 bg-orange-100 text-orange-800 rounded text-xs">{{ article.subreddit }}</span>
                {% endif %}
            </div>
        </div>
        
        {% if article.full_text and article.source == 'reddit_comment' %}
        <div class="mt-3 p-3 bg-gray-50 rounded-md">
            <p class="text-sm text-gray-700">
                {% set text = article.full_text %}
                {% for term in article.matched_terms %}
                    {% set found = false %}
                    {% if term in text %}
                        {% set highlighted_term = '<mark class="bg-yellow-200 px-1 rounded">' + term + '</mark>' %}
                        {% set text = text.replace(term, highlighted_term) %}
                        {% set found = true %}
                    {% endif %}
                    {% if not found %}
                        {% set text_upper = text.upper() %}
                        {% set term_upper = term.upper() %}
                        {% if term_upper in text_upper %}
                            {% set pos = text_upper.find(term_upper) %}
                            {% set before = text[:pos] %}
                            {% set after = text[pos + term_upper|length:] %}
                            {% set actual_term = text[pos:pos + term_upper|length] %}
                            {% set highlighted_term = '<mark class="bg-yellow-200 px-1 rounded">' + actual_term + '</mark>' %}
                            {% set text = before + highlighted_term + after %}
                            {% set found = true %}
                        {% endif %}
                    {% endif %}
                    {% if not found %}
                        {% set text_lower = text.lower() %}
                        {% set term_lower = term.lower() %}
                        {% if term_lower in text_lower %}
                            {% set pos = text_lower.find(term_lower) %}
                            {% set before = text[:pos] %}
                            {% set after = text[pos + term_lower|length:] %}
                            {% set actual_term = text[pos:pos + term_lower|length] %}
                            {% set highlighted_term = '<mark class="bg-yellow-200 px-1 rounded">' + actual_term + '</mark>' %}
                            {% set text = before + highlighted_term + after %}
                        {% endif %}
                    {% endif %}
                {% endfor %}
                {{ text|safe }}
            </p>
        </div>
        {% endif %}
    </div>
    {% else %}
    <div class="text-center py-12">
        <div class="text-gray-500">
            <i class="fas fa-newspaper text-4xl mb-4"></i>
            <p class="text-lg">No articles found for {{ ticker }}</p>
            <p class="text-sm">Try adjusting your filters or check back later</p>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Pagination -->
{% if pagination.total_pages > 1 %}
<div class="mt-8 flex justify-center">
    <nav class="flex items-center space-x-2">
        {% if pagination.has_prev %}
        <a href="/t/{{ ticker }}?page={{ pagination.page - 1 }}&sort_by={{ sort_by }}" 
           class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
            Previous
        </a>
        {% else %}
        <span class="px-3 py-2 text-sm font-medium text-gray-400 bg-gray-100 border border-gray-200 rounded-md cursor-not-allowed">
            Previous
        </span>
        {% endif %}
        
        <!-- Page numbers -->
        {% set start_page = [1, pagination.page - 2]|max %}
        {% set end_page = [pagination.total_pages, pagination.page + 2]|min %}
        
        {% if start_page > 1 %}
        <a href="/t/{{ ticker }}?page=1&sort_by={{ sort_by }}" 
           class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">1</a>
        {% if start_page > 2 %}
        <span class="px-2 text-sm text-gray-500">...</span>
        {% endif %}
        {% endif %}
        
        {% for page_num in range(start_page, end_page + 1) %}
        {% if page_num == pagination.page %}
        <span class="px-3 py-2 text-sm font-medium text-white bg-blue-600 border border-blue-600 rounded-md">
            {{ page_num }}
        </span>
        {% else %}
        <a href="/t/{{ ticker }}?page={{ page_num }}&sort_by={{ sort_by }}" 
           class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
            {{ page_num }}
        </a>
        {% endif %}
        {% endfor %}
        
        {% if end_page < pagination.total_pages %}
        {% if end_page < pagination.total_pages - 1 %}
        <span class="px-2 text-sm text-gray-500">...</span>
        {% endif %}
        <a href="/t/{{ ticker }}?page={{ pagination.total_pages }}&sort_by={{ sort_by }}" 
           class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
            {{ pagination.total_pages }}
        </a>
        {% endif %}
        
        {% if pagination.has_next %}
        <a href="/t/{{ ticker }}?page={{ pagination.page + 1 }}&sort_by={{ sort_by }}" 
           class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
            Next
        </a>
        {% else %}
        <span class="px-3 py-2 text-sm font-medium text-gray-400 bg-gray-100 border border-gray-200 rounded-md cursor-not-allowed">
            Next
        </span>
        {% endif %}
    </nav>
</div>

<div class="mt-4 text-center text-sm text-gray-500">
    Showing {{ ((pagination.page - 1) * 50) + 1 }} to {{ [pagination.page * 50, pagination.total_articles]|min }} of {{ pagination.total_articles }} articles
</div>
{% endif %}

<script>
// Sorting functionality - redirect with sort_by parameter
const sortFilter = document.getElementById('sort-filter');

if (sortFilter) {
    sortFilter.addEventListener('change', function() {
        const sortValue = this.value;
        const currentUrl = new URL(window.location.href);
        
        // Update or add sort_by parameter
        currentUrl.searchParams.set('sort_by', sortValue);
        
        // Reset to page 1 when changing sort
        currentUrl.searchParams.set('page', '1');
        
        // Redirect to new URL
        window.location.href = currentUrl.toString();
    });
}

// Sentiment Area Chart
const ticker = '{{ ticker }}';
let sentimentChart = null;

async function loadSentimentTimeline(period, metric) {
    try {
        const response = await fetch(`/api/ticker/${ticker}/sentiment-timeline?period=${period}&metric=${metric}`);
        if (!response.ok) {
            throw new Error('Failed to fetch sentiment timeline data');
        }
        const data = await response.json();
        renderSentimentChart(data, period, metric);
    } catch (error) {
        console.error('Error loading sentiment timeline:', error);
    }
}

function formatTimestamp(timestamp, period) {
    // Parse the UTC timestamp - Date object automatically converts to local timezone
    const date = new Date(timestamp);
    if (period === 'day') {
        // Show hour in local timezone (e.g., "14:00")
        const hh = String(date.getHours()).padStart(2, '0');
        const mi = String(date.getMinutes()).padStart(2, '0');
        return `${hh}:${mi}`;
    } else {
        // Show month/day (e.g., "10/24")
        const mm = date.getMonth() + 1;
        const dd = date.getDate();
        return `${mm}/${dd}`;
    }
}

function renderSentimentChart(data, period, metric) {
    const ctx = document.getElementById('sentimentAreaChart');
    if (!ctx) return;
    
    // Destroy existing chart if it exists
    if (sentimentChart) {
        sentimentChart.destroy();
    }
    
    const labels = data.data.map(d => formatTimestamp(d.timestamp, period));
    const totalData = data.data.map(d => d.total);
    const positiveData = data.data.map(d => d.positive);
    const negativeData = data.data.map(d => d.negative);
    const neutralData = data.data.map(d => d.neutral);
    
    // Dynamic labels based on metric
    const metricLabel = metric === 'users' ? 'Users' : 'Comments';
    const totalLabel = metric === 'users' ? 'Total Users' : 'Total Comments';
    
    // Update legend text
    const legendTotal = document.getElementById('legend-total');
    if (legendTotal) {
        legendTotal.textContent = totalLabel;
    }
    
    sentimentChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: totalLabel,
                    data: totalData,
                    fill: true,
                    backgroundColor: 'rgba(96, 165, 250, 0.2)', // blue-400 with opacity
                    borderColor: 'rgba(96, 165, 250, 0.8)',
                    borderWidth: 2,
                    tension: 0.4,
                    order: 3
                },
                {
                    label: 'Positive',
                    data: positiveData,
                    fill: true,
                    backgroundColor: 'rgba(16, 185, 129, 0.3)', // green-500 with opacity
                    borderColor: 'rgba(16, 185, 129, 0.8)',
                    borderWidth: 2,
                    tension: 0.4,
                    order: 2
                },
                {
                    label: 'Negative',
                    data: negativeData,
                    fill: true,
                    backgroundColor: 'rgba(239, 68, 68, 0.3)', // red-500 with opacity
                    borderColor: 'rgba(239, 68, 68, 0.8)',
                    borderWidth: 2,
                    tension: 0.4,
                    order: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            scales: {
                y: {
                    beginAtZero: true,
                    stacked: false,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        precision: 0
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45,
                        autoSkip: true,
                        maxTicksLimit: period === 'day' ? 12 : 15
                    }
                }
            },
            plugins: {
                legend: {
                    display: false  // We have custom legend below the chart
                },
                tooltip: {
                    displayColors: false,
                    callbacks: {
                        title: function(context) {
                            const dataIndex = context[0].dataIndex;
                            const timestamp = data.data[dataIndex].timestamp;
                            const date = new Date(timestamp);
                            
                            if (period === 'day') {
                                // Format as "Hour: 14:00" in local timezone
                                const hh = String(date.getHours()).padStart(2, '0');
                                const mi = String(date.getMinutes()).padStart(2, '0');
                                return `Hour: ${hh}:${mi}`;
                            } else {
                                // Format as "Date: 10/24/2025" in local timezone
                                const mm = date.getMonth() + 1;
                                const dd = date.getDate();
                                const yyyy = date.getFullYear();
                                return `Date: ${mm}/${dd}/${yyyy}`;
                            }
                        },
                        beforeBody: function(context) {
                            const dataIndex = context[0].dataIndex;
                            const total = totalData[dataIndex];
                            const positive = positiveData[dataIndex];
                            const negative = negativeData[dataIndex];
                            const neutral = neutralData[dataIndex];
                            
                            // Build tooltip in order: Total, bigger sentiment, smaller sentiment, neutral
                            const lines = [];
                            lines.push(`${totalLabel}: ${total} ${metricLabel.toLowerCase()}`);
                            lines.push('');  // Add spacing
                            
                            if (positive > negative) {
                                lines.push(`Positive: ${positive} ${metricLabel.toLowerCase()}`);
                                lines.push(`Negative: ${negative} ${metricLabel.toLowerCase()}`);
                            } else if (negative > positive) {
                                lines.push(`Negative: ${negative} ${metricLabel.toLowerCase()}`);
                                lines.push(`Positive: ${positive} ${metricLabel.toLowerCase()}`);
                            } else {
                                // Equal, show positive first
                                lines.push(`Positive: ${positive} ${metricLabel.toLowerCase()}`);
                                lines.push(`Negative: ${negative} ${metricLabel.toLowerCase()}`);
                            }
                            
                            lines.push(`Neutral: ${neutral} ${metricLabel.toLowerCase()}`);
                            
                            return lines;
                        },
                        label: function(context) {
                            // Hide default labels since we're using beforeBody
                            return null;
                        }
                    }
                }
            }
        }
    });
}

// Load initial data on page load
document.addEventListener('DOMContentLoaded', function() {
    const periodSelector = document.getElementById('period-selector');
    const metricSelector = document.getElementById('metric-selector');
    
    // Load initial chart with default values (day, comments)
    loadSentimentTimeline('day', 'comments');
    
    // Handle period selector changes
    if (periodSelector) {
        periodSelector.addEventListener('change', function() {
            const currentMetric = metricSelector ? metricSelector.value : 'comments';
            loadSentimentTimeline(this.value, currentMetric);
        });
    }
    
    // Handle metric selector changes
    if (metricSelector) {
        metricSelector.addEventListener('change', function() {
            const currentPeriod = periodSelector ? periodSelector.value : 'month';
            loadSentimentTimeline(currentPeriod, this.value);
        });
    }
});
</script>
{% endblock %}
