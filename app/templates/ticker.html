{% extends "base.html" %}

{% block title %}{{ ticker }} - AlexStocks{% endblock %}

{% block content %}
<div class="mb-8">
    <div class="flex items-center justify-between">
        <div>
            <div class="flex items-center gap-3 mb-2">
                <h1 class="text-3xl font-bold text-gray-900">{{ ticker }}</h1>
                <button 
                    id="ticker-watchlist-btn"
                    class="px-3 py-1 text-sm font-medium rounded-md {% if is_following %}bg-green-50 text-green-700 hover:bg-green-100{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %} transition-colors flex items-center gap-2"
                    data-symbol="{{ ticker }}"
                    data-following="{% if is_following %}true{% else %}false{% endif %}"
                    title="{% if is_following %}Remove from watchlist{% else %}Add to watchlist{% endif %}"
                >
                    <i class="fas fa-star {% if is_following %}text-yellow-500{% else %}text-gray-400{% endif %}"></i>
                    <span>{% if is_following %}Following{% else %}Add to Watchlist{% endif %}</span>
                </button>
            </div>
            {% if ticker_obj %}
            <p class="text-gray-600">{{ ticker_obj.name }} - Recent news and sentiment analysis</p>
            {% else %}
            <p class="text-gray-600">Recent news and sentiment analysis</p>
            {% endif %}
            <p class="text-sm text-gray-500 mt-2">Default charts cover the last 25 hours by "day" period and sentiment shares compare positive vs. negative mentions after removing neutral posts.</p>
            <div class="mt-2 flex items-center space-x-4 text-sm text-gray-500">
                {% if pagination.total_pages > 1 %}
                <span class="flex items-center">
                    <i class="fas fa-list mr-1"></i>
                    Page {{ pagination.page }} of {{ pagination.total_pages }}
                </span>
                {% endif %}
            </div>
        </div>
        <a href="/" class="text-blue-600 hover:text-blue-800">
            ‚Üê Back to all tickers
        </a>
    </div>
</div>

<!-- Stock Price & Metrics Display -->
<div class="bg-white rounded-lg shadow-sm border p-4 md:p-6 mb-6">
    <div class="grid grid-cols-4 gap-2 md:gap-6">
        <!-- Stock Price -->
        {% if stock_data %}
        <div class="text-center">
            <h3 class="text-xs md:text-sm font-medium text-gray-500 mb-1">Price</h3>
            <div class="text-lg md:text-2xl font-bold text-gray-900">
                ${{ "%.2f"|format(stock_data.price) }}
            </div>
            <div class="flex flex-col md:flex-row items-center justify-center space-y-0 md:space-y-0 md:space-x-2 mt-1">
                {% set change_color = "text-green-600" if stock_data.change >= 0 else "text-red-600" %}
                <span class="text-xs md:text-sm {{ change_color }} font-medium">
                    {{ "+" if stock_data.change >= 0 else "" }}${{ "%.2f"|format(stock_data.change) }}
                </span>
                <span class="text-xs md:text-sm {{ change_color }}">
                    ({{ "+" if stock_data.change >= 0 else "" }}{{ "%.1f"|format(stock_data.change_percent) }}%)
                </span>
            </div>
            <div class="text-xs text-gray-500 mt-1">
                {{ stock_data.exchange }} ‚Ä¢ {{ stock_data.currency }}
            </div>
        </div>
        {% endif %}
        
        <!-- Today's Articles -->
        <div class="text-center">
            <h3 class="text-xs md:text-sm font-medium text-gray-500 mb-1">Today</h3>
            <div class="text-lg md:text-2xl font-bold text-gray-900">{{ today_article_count }}</div>
            <div class="flex flex-col md:flex-row items-center justify-center space-y-0 md:space-y-0 md:space-x-2 mt-1">
                {% set change_color = "text-green-600" if article_change >= 0 else "text-red-600" %}
                <span class="text-xs md:text-sm {{ change_color }} font-medium">
                    {{ "+" if article_change >= 0 else "" }}{{ article_change }}
                </span>
                <span class="text-xs md:text-sm {{ change_color }}">
                    ({{ "+" if article_change >= 0 else "" }}{{ "%.1f"|format(article_change_percent) }}%)
                </span>
            </div>
            <div class="text-xs text-gray-500 mt-1">vs yesterday</div>
        </div>
        
        <!-- Users Talking Today -->
        <div class="text-center">
            <h3 class="text-xs md:text-sm font-medium text-gray-500 mb-1">Users</h3>
            <div class="text-lg md:text-2xl font-bold text-gray-900">{{ unique_users_today }}</div>
            <div class="flex flex-col md:flex-row items-center justify-center space-y-0 md:space-y-0 md:space-x-2 mt-1">
                {% set change_color = "text-green-600" if users_change >= 0 else "text-red-600" %}
                <span class="text-xs md:text-sm {{ change_color }} font-medium">
                    {{ "+" if users_change >= 0 else "" }}{{ users_change }}
                </span>
                <span class="text-xs md:text-sm {{ change_color }}">
                    ({{ "+" if users_change >= 0 else "" }}{{ "%.1f"|format(users_change_percent) }}%)
                </span>
            </div>
            <div class="text-xs text-gray-500 mt-1">vs yesterday</div>
        </div>
        
        <!-- Total Articles -->
        <div class="text-center">
            <h3 class="text-xs md:text-sm font-medium text-gray-500 mb-1">Total</h3>
            <div class="text-lg md:text-2xl font-bold text-gray-900">{{ total_article_count }}</div>
            <div class="text-xs text-gray-500 mt-1">Since Oct 2025</div>
        </div>
    </div>
</div>

<!-- Combined Price & Sentiment Timeline Chart -->
<div class="bg-white rounded-lg shadow-sm border p-4 md:p-6 mb-6">
    <div class="mb-4">
        <h2 class="text-lg font-semibold text-gray-900 mb-3">
            <i class="fas fa-chart-line text-blue-600 mr-2"></i>
            {{ ticker }} Price & Sentiment Over Time
        </h2>
        <div class="flex flex-col sm:flex-row sm:items-center gap-3">
            <div class="flex items-center space-x-2">
                <label for="metric-selector" class="text-sm font-medium text-gray-700 whitespace-nowrap">Metric:</label>
                <select id="metric-selector" class="flex-1 sm:flex-none px-3 py-1.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 text-sm">
                    <option value="comments" selected>By Comments</option>
                    <option value="users">By Unique Users</option>
                </select>
            </div>
            <div class="flex items-center space-x-2">
                <label for="period-selector" class="text-sm font-medium text-gray-700 whitespace-nowrap">Period:</label>
                <select id="period-selector" class="flex-1 sm:flex-none px-3 py-1.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 text-sm">
                    <option value="day" selected>Last 25 Hours</option>
                    <option value="week">Last 7 Days</option>
                    <option value="month">Last 30 Days</option>
                </select>
            </div>
        </div>
    </div>
    
    <div class="h-80 mb-4">
        <canvas id="combinedChart"></canvas>
    </div>

    <div class="flex flex-wrap items-center justify-center gap-4 text-xs text-gray-600">
        <div class="flex items-center space-x-1 cursor-pointer hover:opacity-75" onclick="toggleDataset(0)">
            <div class="w-3 h-3 rounded-full" style="background-color: rgb(255, 159, 64);"></div>
            <span class="font-semibold">üí∞ Price</span>
        </div>
        <div class="flex items-center space-x-1 cursor-pointer hover:opacity-75" onclick="toggleDataset(1)">
            <div class="w-3 h-3 rounded-full bg-blue-400"></div>
            <span id="legend-total">Total Comments</span>
        </div>
        <div class="flex items-center space-x-1 cursor-pointer hover:opacity-75" onclick="toggleDataset(2)">
            <div class="w-3 h-3 rounded-full bg-green-500"></div>
            <span>Positive</span>
        </div>
        <div class="flex items-center space-x-1 cursor-pointer hover:opacity-75" onclick="toggleDataset(3)">
            <div class="w-3 h-3 rounded-full bg-red-500"></div>
            <span>Negative</span>
        </div>
        <div class="text-gray-500 ml-4">
            <i class="fas fa-info-circle"></i> Click legend to show/hide
        </div>
    </div>
    <p class="text-xs text-gray-500 text-center mt-3">Sentiment series exclude neutral posts so the green/red balance matches the bar on the home page; price points use the latest available quote.</p>
</div>


<!-- Filters (server-side) -->
<form id="ticker-filters-form" class="bg-white rounded-lg shadow-sm border p-4 mb-6" method="get">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Sentiment</label>
            <select name="sentiment" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                <option value="" {% if (sentiment|default('')) == '' %}selected{% endif %}>All</option>
                <option value="positive" {% if sentiment=='positive' %}selected{% endif %}>Positive</option>
                <option value="neutral" {% if sentiment=='neutral' %}selected{% endif %}>Neutral</option>
                <option value="negative" {% if sentiment=='negative' %}selected{% endif %}>Negative</option>
            </select>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Source</label>
            <select name="source" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                <option value="" {{ '' == (source|default('')) and 'selected' or '' }}>All</option>
                {% if sources_available %}
                    {% for s in sources_available %}
                        <option value="{{ s }}" {{ source==s and 'selected' or '' }}>{{ s }}</option>
                    {% endfor %}
                {% endif %}
            </select>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Start</label>
            <input type="date" name="start" value="{{ start or '' }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" />
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">End</label>
            <input type="date" name="end" value="{{ end or '' }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" />
        </div>
    </div>
    <div class="mt-4 flex gap-2">
        <button class="px-3 py-2 bg-blue-600 text-white rounded">Apply</button>
        <a href="/t/{{ ticker }}" class="px-3 py-2 border border-gray-300 rounded">Reset</a>
    </div>
    <!-- preserve page reset to 1 automatically by form submit (no page field) -->
</form>
{% if pagination and pagination.total_articles is defined %}
<div class="mt-2 text-sm text-gray-600">
    Showing {{ pagination.total_articles }} article{{ 's' if pagination.total_articles != 1 else '' }} matching filters
    {% if filtered_article_count is defined and filtered_article_count != pagination.total_articles %}
        <!-- Guard if pagination changes in future -->
    {% endif %}
    {% if total_article_count is defined %}
        <span class="text-gray-400">‚Ä¢</span>
        Total available: {{ total_article_count }}
    {% endif %}
    </div>
{% endif %}

<!-- Articles List -->
<div class="space-y-4" id="articles-list">
    {% for article in articles %}
    {% set is_reddit_post = article.source in ['reddit_post', 'reddit'] %}
    {% set is_reddit_comment = article.source == 'reddit_comment' %}
    <div class="bg-white rounded-lg shadow-sm {{ 'border-4' if is_reddit_post else 'border' }} border-gray-200 p-4 md:p-6 article-card" 
         data-published="{{ article.published_at.isoformat() }}"
         data-language="{{ article.lang or 'unknown' }}"
         data-sentiment="{{ get_sentiment_display_data(article.sentiment).label.lower() }}"
         data-sentiment-value="{{ article.sentiment or 0.0 }}"
         data-engagement="{{ article.upvotes or 0 }}"
         data-source="{{ article.source }}">
        <!-- Title -->
        <div class="mb-3">
            <h3 class="text-base md:text-lg font-semibold text-gray-900 line-clamp-2 md:line-clamp-none mb-2">
                <a href="{{ article.url }}" target="_blank" class="hover:text-blue-600">
                    {% set title_text = article.title %}
                    {% for term in article.matched_terms %}
                        {% if term in title_text %}
                            {% set highlighted_term = '<mark class="bg-yellow-200 px-1 rounded">' + term + '</mark>' %}
                            {% set title_text = title_text.replace(term, highlighted_term) %}
                        {% else %}
                            {% set title_upper = title_text.upper() %}
                            {% set term_upper = term.upper() %}
                            {% if term_upper in title_upper %}
                                {% set highlighted_term = '<mark class="bg-yellow-200 px-1 rounded">' + term_upper + '</mark>' %}
                                {% set title_text = title_text.replace(term_upper, highlighted_term) %}
                            {% else %}
                                {% set title_lower = title_text.lower() %}
                                {% set term_lower = term.lower() %}
                                {% if term_lower in title_lower %}
                                    {% set highlighted_term = '<mark class="bg-yellow-200 px-1 rounded">' + term_lower + '</mark>' %}
                                    {% set title_text = title_text.replace(term_lower, highlighted_term) %}
                                {% endif %}
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                    {{ title_text|safe }}
                    <i class="fas fa-external-link-alt text-xs text-gray-400 ml-1"></i>
                </a>
            </h3>
            <!-- Date and Source first -->
            <div class="flex flex-wrap items-center gap-2 text-xs md:text-sm text-gray-500 mb-2">
                {% if article.published_at %}
                <span class="article-time whitespace-nowrap" data-published="{{ article.published_at.isoformat() }}"></span>
                {% else %}
                <span class="whitespace-nowrap">Unknown date</span>
                {% endif %}
                <span class="text-gray-300">‚Ä¢</span>
                <span class="px-2 py-1 rounded text-xs {{ 'bg-orange-100 text-orange-800' if is_reddit_post else ('bg-amber-100 text-amber-800' if is_reddit_comment else 'bg-gray-100 text-gray-600') }}">
                    {% if is_reddit_post or is_reddit_comment %}
                    <i class="fab fa-reddit-alien mr-1"></i>
                    {% endif %}
                    {{ article.source }}
                </span>
            </div>
            <!-- Other metadata -->
            <div class="flex flex-wrap items-center gap-2">
                {% set sentiment_data = get_sentiment_display_data(article.sentiment) %}
                <div class="flex items-center space-x-1">
                    <span class="text-sm">{{ sentiment_data.icon }}</span>
                    <span class="px-2 py-1 text-xs font-medium rounded-full {{ sentiment_data.bg_color }} {{ sentiment_data.text_color }}" data-sentiment="{{ sentiment_data.label.lower() }}">
                        {{ sentiment_data.label }}
                    </span>
                    <span class="text-xs text-gray-500">({{ "%.2f"|format(article.sentiment) }})</span>
                </div>
                <span class="flex items-center text-gray-600 whitespace-nowrap text-xs md:text-sm">
                    <i class="fas fa-arrow-up mr-1"></i>
                    <span class="font-medium">{{ article.upvotes or 0 }}</span>
                </span>
                {% if is_reddit_post %}
                <span class="flex items-center text-gray-600 whitespace-nowrap text-xs md:text-sm">
                    <i class="fas fa-comments mr-1"></i>
                    <span class="font-medium">{{ article.num_comments or 0 }}</span>
                </span>
                {% endif %}
                {% if article.lang %}
                <span class="px-2 py-1 bg-gray-100 rounded text-xs">{{ article.lang.upper() }}</span>
                {% endif %}
                {% if article.author %}
                <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs truncate max-w-[150px]">{{ article.author }}</span>
                {% endif %}
                {% if article.subreddit %}
                <span class="px-2 py-1 bg-orange-100 text-orange-800 rounded text-xs">{{ article.subreddit }}</span>
                {% endif %}
            </div>
        </div>
        
        {% if article.full_text and article.source in ['reddit_comment','reddit_post','reddit'] %}
        <div class="mt-3 p-3 bg-gray-50 rounded-md">
            <p class="text-sm text-gray-700">
                {% set text = article.full_text %}
                {% for term in article.matched_terms %}
                    {% set found = false %}
                    {% if term in text %}
                        {% set highlighted_term = '<mark class="bg-yellow-200 px-1 rounded">' + term + '</mark>' %}
                        {% set text = text.replace(term, highlighted_term) %}
                        {% set found = true %}
                    {% endif %}
                    {% if not found %}
                        {% set text_upper = text.upper() %}
                        {% set term_upper = term.upper() %}
                        {% if term_upper in text_upper %}
                            {% set pos = text_upper.find(term_upper) %}
                            {% set before = text[:pos] %}
                            {% set after = text[pos + term_upper|length:] %}
                            {% set actual_term = text[pos:pos + term_upper|length] %}
                            {% set highlighted_term = '<mark class="bg-yellow-200 px-1 rounded">' + actual_term + '</mark>' %}
                            {% set text = before + highlighted_term + after %}
                            {% set found = true %}
                        {% endif %}
                    {% endif %}
                    {% if not found %}
                        {% set text_lower = text.lower() %}
                        {% set term_lower = term.lower() %}
                        {% if term_lower in text_lower %}
                            {% set pos = text_lower.find(term_lower) %}
                            {% set before = text[:pos] %}
                            {% set after = text[pos + term_lower|length:] %}
                            {% set actual_term = text[pos:pos + term_lower|length] %}
                            {% set highlighted_term = '<mark class="bg-yellow-200 px-1 rounded">' + actual_term + '</mark>' %}
                            {% set text = before + highlighted_term + after %}
                        {% endif %}
                    {% endif %}
                {% endfor %}
                {{ text|safe }}
            </p>
        </div>
        {% endif %}
    </div>
    {% else %}
    <div class="text-center py-12">
        <div class="text-gray-500">
            <i class="fas fa-newspaper text-4xl mb-4"></i>
            <p class="text-lg">No articles found for {{ ticker }}</p>
            <p class="text-sm">Try adjusting your filters or check back later</p>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Pagination -->
{% if pagination.total_pages > 1 %}
<div class="mt-8 flex justify-center">
    <nav class="flex items-center space-x-2">
        {% if pagination.has_prev %}
        <a href="/t/{{ ticker }}?page={{ pagination.page - 1 }}&sentiment={{ sentiment or '' }}&source={{ source or '' }}&start={{ start or '' }}&end={{ end or '' }}" 
           class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
            Previous
        </a>
        {% else %}
        <span class="px-3 py-2 text-sm font-medium text-gray-400 bg-gray-100 border border-gray-200 rounded-md cursor-not-allowed">
            Previous
        </span>
        {% endif %}
        
        <!-- Page numbers -->
        {% set start_page = [1, pagination.page - 2]|max %}
        {% set end_page = [pagination.total_pages, pagination.page + 2]|min %}
        
        {% if start_page > 1 %}
        <a href="/t/{{ ticker }}?page=1&sentiment={{ sentiment or '' }}&source={{ source or '' }}&start={{ start or '' }}&end={{ end or '' }}" 
           class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">1</a>
        {% if start_page > 2 %}
        <span class="px-2 text-sm text-gray-500">...</span>
        {% endif %}
        {% endif %}
        
        {% for page_num in range(start_page, end_page + 1) %}
        {% if page_num == pagination.page %}
        <span class="px-3 py-2 text-sm font-medium text-white bg-blue-600 border border-blue-600 rounded-md">
            {{ page_num }}
        </span>
        {% else %}
        <a href="/t/{{ ticker }}?page={{ page_num }}&sentiment={{ sentiment or '' }}&source={{ source or '' }}&start={{ start or '' }}&end={{ end or '' }}" 
           class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
            {{ page_num }}
        </a>
        {% endif %}
        {% endfor %}
        
        {% if end_page < pagination.total_pages %}
        {% if end_page < pagination.total_pages - 1 %}
        <span class="px-2 text-sm text-gray-500">...</span>
        {% endif %}
        <a href="/t/{{ ticker }}?page={{ pagination.total_pages }}&sentiment={{ sentiment or '' }}&source={{ source or '' }}&start={{ start or '' }}&end={{ end or '' }}" 
           class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
            {{ pagination.total_pages }}
        </a>
        {% endif %}
        
        {% if pagination.has_next %}
        <a href="/t/{{ ticker }}?page={{ pagination.page + 1 }}&sentiment={{ sentiment or '' }}&source={{ source or '' }}&start={{ start or '' }}&end={{ end or '' }}" 
           class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
            Next
        </a>
        {% else %}
        <span class="px-3 py-2 text-sm font-medium text-gray-400 bg-gray-100 border border-gray-200 rounded-md cursor-not-allowed">
            Next
        </span>
        {% endif %}
    </nav>
</div>

<div class="mt-4 text-center text-sm text-gray-500">
    Showing {{ ((pagination.page - 1) * 50) + 1 }} to {{ [pagination.page * 50, pagination.total_articles]|min }} of {{ pagination.total_articles }} articles
</div>
{% endif %}

<script>
// Shared ticker variable and chart instance
const ticker = '{{ ticker }}';
let combinedChart = null;

// Combined Chart Functions
async function loadCombinedChart(period, metric) {
    try {
        // Fetch both price and sentiment data in parallel
        const [priceResponse, sentimentResponse] = await Promise.all([
            fetch(`/api/stock/${ticker}/history?period=${period}`),
            fetch(`/api/ticker/${ticker}/sentiment-timeline?period=${period}&metric=${metric}`)
        ]);
        
        if (!priceResponse.ok || !sentimentResponse.ok) {
            throw new Error('Failed to fetch chart data');
        }
        
        const priceData = await priceResponse.json();
        const sentimentData = await sentimentResponse.json();
        
        renderCombinedChart(priceData, sentimentData, period, metric);
    } catch (error) {
        console.error('Error loading combined chart:', error);
    }
}

function toggleDataset(datasetIndex) {
    if (!combinedChart) return;
    
    const dataset = combinedChart.data.datasets[datasetIndex];
    dataset.hidden = !dataset.hidden;
    combinedChart.update();
}

function renderCombinedChart(priceData, sentimentData, period, metric) {
    const ctx = document.getElementById('combinedChart');
    if (!ctx) return;
    
    // Destroy existing chart if it exists
    if (combinedChart) {
        combinedChart.destroy();
    }
    
    // Use sentiment data labels as the base (more comprehensive)
    const labels = sentimentData.data.map(d => formatTimestamp(d.timestamp, period));
    
    // Helper function to normalize timestamp for matching based on period
    function normalizeTimestampForMatching(timestamp, period) {
        if (period === 'day') {
            // For hourly data, match by date + hour, rounding to nearest hour
            // Sentiment buckets are on the hour (17:00), price data might be at half-hours (17:30)
            if (timestamp.includes('T')) {
                try {
                    const date = new Date(timestamp);
                    // Round to nearest hour
                    date.setMinutes(0, 0, 0);
                    // Format as "YYYY-MM-DDTHH" for matching
                    const year = date.getUTCFullYear();
                    const month = String(date.getUTCMonth() + 1).padStart(2, '0');
                    const day = String(date.getUTCDate()).padStart(2, '0');
                    const hour = String(date.getUTCHours()).padStart(2, '0');
                    return `${year}-${month}-${day}T${hour}`;
                } catch (e) {
                    // Fallback: extract date and hour from string
                    return timestamp.substring(0, 13);
                }
            }
            // Fallback for date-only format
            return timestamp.substring(0, 10);
        } else {
            // For week/month (daily data), match by date only
            return timestamp.substring(0, 10); // YYYY-MM-DD
        }
    }
    
    // Create price data array aligned with sentiment labels
    const priceDataPoints = [];
    const priceMap = new Map();
    priceData.data.forEach(p => {
        const key = normalizeTimestampForMatching(p.date, period);
        priceMap.set(key, p.close);
    });
    
    // Align price data with sentiment timestamps
    sentimentData.data.forEach(s => {
        const key = normalizeTimestampForMatching(s.timestamp, period);
        priceDataPoints.push(priceMap.get(key) || null);
    });
    
    const totalData = sentimentData.data.map(d => d.total);
    const positiveData = sentimentData.data.map(d => d.positive);
    const negativeData = sentimentData.data.map(d => d.negative);
    
    // Dynamic labels based on metric
    const metricLabel = metric === 'users' ? 'Users' : 'Comments';
    const totalLabel = metric === 'users' ? 'Total Users' : 'Total Comments';
    
    // Update legend text
    const legendTotal = document.getElementById('legend-total');
    if (legendTotal) {
        legendTotal.textContent = totalLabel;
    }
    
    combinedChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Price ($)',
                    data: priceDataPoints,
                    yAxisID: 'y-price',
                    borderColor: 'rgb(255, 159, 64)', // Orange - very visible
                    backgroundColor: 'rgba(255, 159, 64, 0.1)',
                    borderWidth: 4, // Thick line
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: 'rgb(255, 159, 64)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    fill: false,
                    order: 0 // Draw on top
                },
                {
                    label: totalLabel,
                    data: totalData,
                    yAxisID: 'y-sentiment',
                    fill: true,
                    backgroundColor: 'rgba(96, 165, 250, 0.2)',
                    borderColor: 'rgba(96, 165, 250, 0.8)',
                    borderWidth: 2,
                    tension: 0.4,
                    order: 3
                },
                {
                    label: 'Positive',
                    data: positiveData,
                    yAxisID: 'y-sentiment',
                    fill: true,
                    backgroundColor: 'rgba(16, 185, 129, 0.3)',
                    borderColor: 'rgba(16, 185, 129, 0.8)',
                    borderWidth: 2,
                    tension: 0.4,
                    order: 2
                },
                {
                    label: 'Negative',
                    data: negativeData,
                    yAxisID: 'y-sentiment',
                    fill: true,
                    backgroundColor: 'rgba(239, 68, 68, 0.3)',
                    borderColor: 'rgba(239, 68, 68, 0.8)',
                    borderWidth: 2,
                    tension: 0.4,
                    order: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            scales: {
                'y-price': {
                    type: 'linear',
                    position: 'right',
                    beginAtZero: false,
                    grid: {
                        drawOnChartArea: false, // Don't draw grid lines
                    },
                    ticks: {
                        color: 'rgb(255, 159, 64)',
                        callback: function(value) {
                            return '$' + value.toFixed(2);
                        },
                        font: {
                            weight: 'bold'
                        }
                    },
                    title: {
                        display: true,
                        text: 'Price ($)',
                        color: 'rgb(255, 159, 64)',
                        font: {
                            weight: 'bold',
                            size: 14
                        }
                    }
                },
                'y-sentiment': {
                    type: 'linear',
                    position: 'left',
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        precision: 0
                    },
                    title: {
                        display: true,
                        text: metricLabel,
                        font: {
                            weight: 'bold',
                            size: 14
                        }
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45,
                        autoSkip: true,
                        maxTicksLimit: period === 'day' ? 12 : 15
                    }
                }
            },
            plugins: {
                legend: {
                    display: false  // Custom legend below
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            const dataIndex = context[0].dataIndex;
                            const timestamp = sentimentData.data[dataIndex].timestamp;
                            const date = new Date(timestamp);
                            
                            if (period === 'day') {
                                const hh = String(date.getHours()).padStart(2, '0');
                                const mi = String(date.getMinutes()).padStart(2, '0');
                                return `Hour: ${hh}:${mi}`;
                            } else {
                                const mm = date.getMonth() + 1;
                                const dd = date.getDate();
                                const yyyy = date.getFullYear();
                                return `Date: ${mm}/${dd}/${yyyy}`;
                            }
                        },
                        label: function(context) {
                            const label = context.dataset.label || '';
                            const value = context.parsed.y;
                            
                            if (label.includes('Price')) {
                                return `${label}: $${value.toFixed(2)}`;
                            } else {
                                return `${label}: ${value} ${metricLabel.toLowerCase()}`;
                            }
                        }
                    }
                }
            }
        }
    });
}

// Sentiment Timeline Chart Functions
async function loadSentimentTimeline(period, metric) {
    try {
        const response = await fetch(`/api/ticker/${ticker}/sentiment-timeline?period=${period}&metric=${metric}`);
        if (!response.ok) {
            throw new Error('Failed to fetch sentiment timeline data');
        }
        const data = await response.json();
        
        // Create time buckets if not already created
        if (!currentTimeBuckets) {
            currentTimeBuckets = createTimeBuckets(period);
        }
        
        renderSentimentChart(data, period, metric, currentTimeBuckets);
    } catch (error) {
        console.error('Error loading sentiment timeline:', error);
    }
}

function formatTimestamp(timestamp, period) {
    // Parse the UTC timestamp - Date object automatically converts to local timezone
    const date = new Date(timestamp);
    if (period === 'day') {
        // Show hour in local timezone (e.g., "14:00")
        const hh = String(date.getHours()).padStart(2, '0');
        const mi = String(date.getMinutes()).padStart(2, '0');
        return `${hh}:${mi}`;
    } else {
        // Show month/day (e.g., "10/24")
        const mm = date.getMonth() + 1;
        const dd = date.getDate();
        return `${mm}/${dd}`;
    }
}

// Load initial data on page load
document.addEventListener('DOMContentLoaded', function() {
    const periodSelector = document.getElementById('period-selector');
    const metricSelector = document.getElementById('metric-selector');
    
    // Load initial combined chart with default values
    const initialPeriod = 'day';
    const initialMetric = 'comments';
    
    loadCombinedChart(initialPeriod, initialMetric);
    
    // Handle period selector changes
    if (periodSelector) {
        periodSelector.addEventListener('change', function() {
            const currentMetric = metricSelector ? metricSelector.value : 'comments';
            loadCombinedChart(this.value, currentMetric);
        });
    }
    
    // Handle metric selector changes
    if (metricSelector) {
        metricSelector.addEventListener('change', function() {
            const currentPeriod = periodSelector ? periodSelector.value : 'day';
            loadCombinedChart(currentPeriod, this.value);
        });
    }
});

// Watchlist functionality
const watchlistBtn = document.getElementById('ticker-watchlist-btn');
if (watchlistBtn) {
    watchlistBtn.addEventListener('click', async function(e) {
        e.preventDefault();
        const symbol = this.dataset.symbol;
        const isFollowing = this.dataset.following === 'true';
        
        // Disable button during request
        this.disabled = true;
        
        try {
            if (isFollowing) {
                // Remove from watchlist
                const response = await fetch(`/api/users/me/follows/${symbol}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    this.dataset.following = 'false';
                    this.classList.remove('bg-green-50', 'text-green-700', 'hover:bg-green-100');
                    this.classList.add('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
                    
                    // Update button text and star color
                    const icon = this.querySelector('i.fa-star');
                    const span = this.querySelector('span');
                    if (icon) {
                        icon.classList.remove('text-yellow-500');
                        icon.classList.add('text-gray-400');
                    }
                    if (span) span.textContent = 'Add to Watchlist';
                } else {
                    const error = await response.json();
                    alert(error.detail || 'Failed to remove from watchlist');
                }
            } else {
                // Add to watchlist
                const response = await fetch('/api/users/me/follows', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({ ticker: symbol })
                });
                
                if (response.ok) {
                    this.dataset.following = 'true';
                    this.classList.remove('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
                    this.classList.add('bg-green-50', 'text-green-700', 'hover:bg-green-100');
                    
                    // Update button text and star color
                    const icon = this.querySelector('i.fa-star');
                    const span = this.querySelector('span');
                    if (icon) {
                        icon.classList.remove('text-gray-400');
                        icon.classList.add('text-yellow-500');
                    }
                    if (span) span.textContent = 'Following';
                } else {
                    let errorMessage = 'Failed to add to watchlist';
                    try {
                        const errorData = await response.json();
                        if (errorData.detail) {
                            if (typeof errorData.detail === 'string') {
                                errorMessage = errorData.detail;
                            } else if (Array.isArray(errorData.detail)) {
                                errorMessage = errorData.detail.map((e) => e.msg || JSON.stringify(e)).join(', ');
                            } else {
                                errorMessage = JSON.stringify(errorData.detail);
                            }
                        }
                    } catch (e) {
                        errorMessage = `Error ${response.status}: ${response.statusText}`;
                    }
                    
                    if (response.status === 401) {
                        alert('Please log in to add tickers to your watchlist');
                    } else {
                        alert(errorMessage);
                    }
                }
            }
        } catch (error) {
            console.error('Watchlist error:', error);
            alert('An error occurred. Please try again.');
        } finally {
            this.disabled = false;
        }
    });
}
</script>
{% endblock %}

